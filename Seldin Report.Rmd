---
title: "Seldin Report: Ssec Scores"
author: "Angela Yoder"
date: "`r Sys.Date()`"
---

**The goals of this program are:**

1. Report on Ssec scores from "Seldin Methods"
  a. Find distribution of Ssec values
  b. Find distribution of correlation p-values
  c. Find a null distribution of Ssec values
  
```{r, echo = FALSE, message = FALSE}

library(tidyverse)
library(reshape2)
library(WGCNA)
#library(reshape)
#library(ggplot2)

# Data Input

#setwd("C:/Users/angel/OneDrive/Desktop/Saba Lab/Data/")
setwd("C:/Users/yodeange/OneDrive - The University of Colorado Denver/Saba Lab/Data")
protein_liver = read.csv("Liver_WGCNA.csv")
protein_brain = read.csv("Brain_WGCNA.csv")
secreted_protein_brain = read.csv("Secreted_Brain.csv")
secreted_protein_liver = read.csv("Secreted_Liver.csv")
sec_annot = read.csv("Sec_Annotation.csv")
tissuespec_protein_brain = read.csv("TissueSpecific_Protein_Brain.csv")
tissuespec_protein_liver = read.csv("TissueSpecific_Protein_Liver.csv")
ts_protein_brain = read.csv("TissueSpecific2_Protein_Brain.csv")
ts_protein_liver = read.csv("TissueSpecific2_Protein_Liver.csv")
tsns_protein_brain = read.csv("NSTissueSpecific_Protein_Brain.csv")
tsns_protein_liver = read.csv("NSTissueSpecific_Protein_Liver.csv")

fix.read.csv = function(x)
{
  names = x[,1]
  gee = x[,2:dim(x)[2]]
  rownames(gee) = names
  return(gee)
}

protein_liver = fix.read.csv(protein_liver)
protein_brain = fix.read.csv(protein_brain)
secreted_protein_brain = fix.read.csv(secreted_protein_brain)
secreted_protein_liver = fix.read.csv(secreted_protein_liver)
sec_annot = fix.read.csv(sec_annot)
tissuespec_protein_brain = fix.read.csv(tissuespec_protein_brain)
tissuespec_protein_liver = fix.read.csv(tissuespec_protein_liver)
ts_protein_brain = fix.read.csv(ts_protein_brain)
ts_protein_liver = fix.read.csv(ts_protein_liver)
tsns_protein_brain = fix.read.csv(tsns_protein_brain)
tsns_protein_liver = fix.read.csv(tsns_protein_liver)

```
Tissue-Specific Secreted > all target proteins
Secreted > all target proteins
Tissue-Specific Secreted > Tissue-Specific Non-Secreted
Tissue-Specific Non-Secreted > all target proteins
Tissue-Specific Non-Secreted > Tissue-Specific Non-Secreted
TRYING all origin proteins > all target proteins- SERVER
Maybe try doing tissue specific non-secreted and tissue specific secreted as target 

```{r, echo = FALSE, message = FALSE}
# Calculate Ssec values: tissue-specific -> ns tissue-specific
#### TS ####
## BRAIN ##

brain.liv = bicorAndPvalue(ts_protein_brain, tsns_protein_liver, use = 'pairwise.complete.obs')
# brain.liv$p

scores = rowSums(-log(brain.liv$p))

ts_Ssec_brain = data.frame(Gene_symbol = names(scores), score = scores) %>%
  #filter(Gene_symbol %in% sec_annot$ensembl_gene_id) %>%
  mutate(Ssec = score / length(colnames(tsns_protein_liver))) %>%
  dplyr::select(-score) %>%
  arrange(desc(Ssec))

#ts_Ssec_brain = Ssec_brain[Ssec_brain[,1] %in% colnames(ts_protein_brain),]
top_brain = head(ts_Ssec_brain[,1])
bot_brain = tail(ts_Ssec_brain[,1])


## LIVER ##

liv.brain = bicorAndPvalue(ts_protein_liver, tsns_protein_brain, use = 'pairwise.complete.obs')
# brain.liv$p

scores = rowSums(-log(liv.brain$p))

ts_Ssec_liver = data.frame(Gene_symbol = names(scores), score = scores) %>%
  #filter(Gene_symbol %in% sec_annot$ensembl_gene_id) %>%
  mutate(Ssec = score / length(colnames(tsns_protein_brain))) %>%
  dplyr::select(-score) %>%
  arrange(desc(Ssec))

#ts_Ssec_liver = Ssec_liver[Ssec_liver[,1] %in% colnames(ts_protein_liver),]
top_liver = head(ts_Ssec_liver[,1])
bot_liver = tail(ts_Ssec_liver[,1])

#### TSNS ####
# ns tissue-specific -> ns tissue-specific
## BRAIN ##

brain.liv = bicorAndPvalue(tsns_protein_brain, tsns_protein_liver, use = 'pairwise.complete.obs')
# brain.liv$p

scores = rowSums(-log(brain.liv$p))

tsns_Ssec_brain = data.frame(Gene_symbol = names(scores), score = scores) %>%
  #filter(Gene_symbol %in% sec_annot$ensembl_gene_id) %>%
  mutate(Ssec = score / length(colnames(tsns_protein_liver))) %>%
  dplyr::select(-score) %>%
  arrange(desc(Ssec))

#ts_Ssec_brain = Ssec_brain[Ssec_brain[,1] %in% colnames(ts_protein_brain),]
#top_brain = head(tsns_Ssec_brain[,1])
#bot_brain = tail(ts_Ssec_brain[,1])


## LIVER ##

liv.brain = bicorAndPvalue(tsns_protein_liver, tsns_protein_brain, use = 'pairwise.complete.obs')
# brain.liv$p

scores = rowSums(-log(liv.brain$p))

tsns_Ssec_liver = data.frame(Gene_symbol = names(scores), score = scores) %>%
  #filter(Gene_symbol %in% sec_annot$ensembl_gene_id) %>%
  mutate(Ssec = score / length(colnames(tsns_protein_brain))) %>%
  dplyr::select(-score) %>%
  arrange(desc(Ssec))

#ts_Ssec_liver = Ssec_liver[Ssec_liver[,1] %in% colnames(ts_protein_liver),]
#top_liver = head(ts_Ssec_liver[,1])
#bot_liver = tail(ts_Ssec_liver[,1])

```

```{r}
# this isn't working great- probably server
ints = c(1, 1500, 1501, 3000, 3001, 4500, 4501, 6000, 6001, 7500, 7501, 9000, 9001, 10500, 10501, 12000, 12001, 13500, 13501, 15000, 15001, 16457)


bee = matrix(data = NA, nrow = 0, ncol = 2)
bee = as.data.frame(bee)
count = 1

for (i in 1:11)
{
  interval = protein_brain[, ints[count]:ints[count +1]]
brain.liv = bicorAndPvalue(interval, protein_liver, use = 'pairwise.complete.obs')
scores = rowSums(-log(liv.brain$p))

full_Ssec_brain = data.frame(Gene_symbol = names(scores), score = scores) %>%
  #filter(Gene_symbol %in% sec_annot$ensembl_gene_id) %>%
  mutate(Ssec = score / length(colnames(protein_liver))) %>%
  dplyr::select(-score) %>%
  arrange(desc(Ssec))
bee = rbind(bee, full_Ssec_brain)
count = count + 2
}


```

```{r, echo = FALSE}
# Visualizations
#hist(Ssec_brain$Ssec)
#hist(ts_Ssec_brain$Ssec)

# Ssec distribtions TSNS v. TS, brain and liver
#Brain
h1 = cbind(rep("TSNS brain", times = length(tsns_Ssec_brain$Ssec)), tsns_Ssec_brain$Ssec)
h2 = cbind(rep("TS brain", times = length(ts_Ssec_brain$Ssec)), ts_Ssec_brain$Ssec)

compare = rbind(h1, h2)
colnames(compare) = c("trt", "val")
compare = as.data.frame(compare)
compare$trt = as.factor(compare$trt)
compare$val = as.numeric(compare$val)


ggplot(compare, aes(val, color = trt)) + 
  geom_density() +
  labs(title="Brain Ssec Distribution: TSNS Proteins v. TS Proteins", x = "Ssec", y = "Density")

# Liver
h1 = cbind(rep("TSNS liver", times = length(tsns_Ssec_liver$Ssec)), tsns_Ssec_liver$Ssec)
h2 = cbind(rep("TS liver", times = length(ts_Ssec_liver$Ssec)), ts_Ssec_liver$Ssec)

compare = rbind(h1, h2)
colnames(compare) = c("trt", "val")
compare = as.data.frame(compare)
compare$trt = as.factor(compare$trt)
compare$val = as.numeric(compare$val)


ggplot(compare, aes(val, color = trt)) + 
  geom_density() +
  labs(title="Liver Ssec Distribution: TSNS Proteins v. TS Proteins", x = "Ssec", y = "Density")

```

# interpretation 

```{r, echo = FALSE}
## Pvalue for top and bottom Ssec scores, liver and brain
# brain
plotting = melt(brain.liv$p, id.vars = "refseq")
limit = plotting[as.character(plotting$Var1) %in% c(top_brain, bot_brain),]

ggplot(limit, aes(value, color = Var1)) + 
  geom_density() +
  labs(title="P-Value Density Curve: Top6 and Bottom6 Brain Proteins", x = "P-Value", y = "Density")

# liver
plotting = melt(liv.brain$p, id.vars = "refseq")
limit = plotting[as.character(plotting$Var1) %in% c(top_liver, bot_liver),]

ggplot(limit, aes(value, color = Var1)) + 
  geom_density() +
  labs(title="P-Value Density Curve: Top6 and Bottom6 Liver Proteins", x = "P-Value", y = "Density")


```

The above two plots are the density distribution of p-values within the proteins with the highest and lowest Ssec scores. We can see that the top Ssec score proteins have a peak on the lower end of p-values, which makes sense given they have the highest Ssec scores. Are there a high number of low but not significantly low p-values that could inflate these? Are we discounting some relationships because there aren't a lot of connections, but a small number of strong connections? The log transformation of the pvalues should weigh the lowest p-values much higher. Don't want to entirely discount pvalues just under a certain threshold. 
 

```{r, echo = FALSE}
# Correlation coefficients top and bottom Ssec scores, liver and brain
# brain
magn = brain.liv$bicor

plotting = melt(magn, id.vars = "refseq")
limit = rbind(plotting[as.character(plotting$Var1) %in% top_brain,], plotting[as.character(plotting$Var1) %in% bot_brain,])

ggplot(limit, aes(value, color = Var1)) + 
  geom_density() +
  labs(title="Magnitude Density Curve: Top6 and Bottom6 Brain Proteins", x = "Correlation", y = "Density")

# liver
magn = liv.brain$bicor
plotting = melt(magn, id.vars = "refseq")
limit = rbind(plotting[as.character(plotting$Var1) %in% top_liver,], plotting[as.character(plotting$Var1) %in% bot_liver,])

ggplot(limit, aes(value, color = Var1)) + 
  geom_density() +
  labs(title="Magnitude Density Curve: Top6 and Bottom6 Liver Proteins", x = "Correlation", y = "Density")

```

Using the same top and bottom proteins, the above graphs show the correlation from the bicor calculation. The curves that are wider at the bottom are the top proteins, indicating that the more significant proteins also have greater correlation coefficients. 

PERMUTATION

We permuted the target tissue strains and recalculated Ssec to
construct the null distribution and maintain the gene-gene correlation structures in each tissue. These tests typically required
1,000â€“1,000,000 permutations, listed as p values in Table S1.
The permutation tests were designed to specifically to allow generation of a statistic while maintaining correlation structure to
limit the influence of inflation of cross-tissue gene correlations
(discussed below). We note that in these tests the p values
used reflect a placeholder for the correlation coefficient, which
does not require independence. 


```{r, eval = FALSE}

#permute strain names in target tissue array
# bicor> pval> Ssec val
# repeat 1000- compare observed value to mean of permuted values
target_protein = protein_liver
perm_test = matrix(NA, ncol = 1000, nrow = 174)
perm_test = as.data.frame(perm_test)
rownames(perm_test) = ts_Ssec_brain[,1]

for (i in 1:1000)
{
  
perm = sample(rownames(target_protein), size = length(rownames(target_protein)), replace = FALSE)
target_protein = target_protein[perm,]

brain.liv = bicorAndPvalue(ts_protein_brain, target_protein, use = 'pairwise.complete.obs')

scores = rowSums(-log(brain.liv$p))

Ssec_brain_perm = data.frame(Gene_symbol = names(scores), score = scores) %>%
  #filter(Gene_symbol %in% sec_annot$ensembl_gene_id) %>%
  mutate(Ssec = score / length(colnames(protein_liver))) %>%
  dplyr::select(-score) %>%
  arrange(desc(Ssec))

perm_test[,i] = Ssec_brain_perm[,2]
} 

## i dont get how this works...

pee = perm_test[rownames(perm_test) == top_brain[2],]
hist(as.numeric(pee))
Ssec_brain[Ssec_brain$Gene_symbol == top_brain[2],]
# ok all of the true values are inside the null distribution. Did i do something wrong??

setwd("C:/Users/yodeange/OneDrive - The University of Colorado Denver/Saba Lab/Data")
write.csv(perm_test, "Permutation_Seldin_Report.csv")

```

